# AjayaDesign Automation â€” Python API + PostgreSQL
#
# Usage:
#   docker compose -f docker-compose.api.yml up --build
#

services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ajayadesign
      POSTGRES_USER: ajaya
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-localdev}
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ajaya"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    ports:
      - "3001:3001"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: "postgresql+asyncpg://ajaya:${POSTGRES_PASSWORD:-localdev}@db:5432/ajayadesign"
      GH_TOKEN: "${GH_TOKEN}"
      AI_PROVIDER: "${AI_PROVIDER:-github-models}"
      AI_TOKEN: "${AI_TOKEN:-}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY:-}"
      GITHUB_ORG: "ajayadesign"
      AI_API_URL: "${AI_API_URL:-}"
      AI_MODEL: "${AI_MODEL:-}"
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN:-}"
      TELEGRAM_CHAT_ID: "${TELEGRAM_CHAT_ID:-}"
      FIREBASE_CRED_PATH: "/app/firebase-service-account.json"
      FIREBASE_DB_URL: "https://ajayadesign-6d739-default-rtdb.firebaseio.com"
      FIREBASE_POLL_INTERVAL: "30"
      BASE_DIR: "/repos"
      MAIN_SITE_DIR: "/site/ajayadesign.github.io"
      HOST_UID: "${HOST_UID:-1000}"
      HOST_GID: "${HOST_GID:-1000}"
      SMTP_EMAIL: "${SMTP_EMAIL:-}"
      SMTP_APP_PASSWORD: "${SMTP_APP_PASSWORD:-}"
      GOOGLE_MAPS_API_KEY: "${GOOGLE_MAPS_API_KEY:-}"
      HUNTER_API_KEY: "${HUNTER_API_KEY:-}"
      SENDER_NAME: "${SENDER_NAME:-AjayaDesign}"
      TRACKING_BASE_URL: "${TRACKING_BASE_URL:-https://api.ajayadesign.com/api/v1/outreach}"
    volumes:
      - repos:/repos
      - ../../:/site
      - ./firebase-service-account.json:/app/firebase-service-account.json:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3001/api/v1/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  pgdata:
  repos:
